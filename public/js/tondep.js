// public/js/tondep.js - Simple TON Deposit v2.0
(() => {
    console.log('[TON] üöÄ Initializing TON deposit module');
  
    // ====== –ö–û–ù–§–ò–ì ======
    const MANIFEST_URL = `${location.origin}/tonconnect-manifest.json`;
    const PROJECT_TON_ADDRESS = "UQCtVhhBFPBvCoT8H7szNQUhEvHgbvnX50r8v6d8y5wdr19J"; // ‚Üê –ó–ê–ú–ï–ù–ò–¢–ï!
    const MIN_DEPOSIT_TON = 0.1;
    const DEPOSIT_AMOUNT = 1.0; // –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—É–º–º–∞ –¥–µ–ø–æ–∑–∏—Ç–∞
  
    // ====== DOM ======
    const tonPill = document.getElementById("tonPill");
    const tonAmount = document.getElementById("tonAmount");
    
    const popup = document.getElementById("tonDepositPopup");
    const backdrop = popup?.querySelector(".ton-popup__backdrop");
    const btnClose = document.getElementById("tonPopupClose");
    
    const bigBalance = document.getElementById("tonBigBalance");
    const walletBalance = document.getElementById("tonWalletBalance");
    
    const btnConnect = document.getElementById("btnConnectWallet");
    const btnDeposit = document.getElementById("btnDepositTon");
  
    if (!popup) {
      console.error('[TON] ‚ùå tonDepositPopup not found!');
      return;
    }
  
    // ====== TELEGRAM ======
    const tg = window.Telegram?.WebApp;
    const tgUserId = tg?.initDataUnsafe?.user?.id || "guest";
    const initData = tg?.initData || "";
  
    // ====== –°–û–°–¢–û–Ø–ù–ò–ï ======
    let currentBalance = 0; // –ë–∞–ª–∞–Ω—Å –Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ
    let currentWalletBalance = null; // –ë–∞–ª–∞–Ω—Å –∫–æ—à–µ–ª—å–∫–∞
  
    // ====== HELPERS ======
    function makeScopedStorage(prefix) {
      return {
        getItem: (k) => localStorage.getItem(`${prefix}:${k}`),
        setItem: (k, v) => localStorage.setItem(`${prefix}:${k}`, v),
        removeItem: (k) => localStorage.removeItem(`${prefix}:${k}`)
      };
    }
  
    function toNanoStr(amount) {
      const s = String(amount).replace(",", ".");
      const [i = "0", f = ""] = s.split(".");
      const frac9 = (f + "000000000").slice(0, 9);
      return (BigInt(i || "0") * 1_000_000_000n + BigInt(frac9)).toString();
    }
  
    function fromNano(nanoStr) {
      const nano = BigInt(nanoStr);
      const ton = Number(nano) / 1_000_000_000;
      return ton.toFixed(2);
    }
  
    // ====== POPUP ======
    function openPopup() {
      console.log('[TON] üìÇ Opening popup');
      popup.classList.add('ton-popup--open');
      updateUI();
      
      if (tc.account) {
        fetchWalletBalance();
      }
      
      if (tg?.HapticFeedback) {
        tg.HapticFeedback.impactOccurred('light');
      }
    }
  
    function closePopup() {
      console.log('[TON] üìÅ Closing popup');
      popup.classList.remove('ton-popup--open');
    }
  
    backdrop?.addEventListener('click', closePopup);
    btnClose?.addEventListener('click', closePopup);
  
    tonPill?.addEventListener('click', (e) => {
      e.preventDefault();
      console.log('[TON] üîò TON pill clicked');
      openPopup();
    });
  
    // ====== TONCONNECT ======
    if (!window.TON_CONNECT_UI) {
      console.error('[TON] ‚ùå TonConnect UI not loaded!');
      return;
    }
  
    const storage = makeScopedStorage(`${tgUserId}:tc`);
  
    console.log('[TON] ‚úÖ Creating TonConnect instance');
  
    const tc = new TON_CONNECT_UI.TonConnectUI({
      manifestUrl: MANIFEST_URL,
      buttonRootId: null,
      uiPreferences: { theme: "SYSTEM" },
      storage,
      restoreConnection: true,
      actionsConfiguration: { twaReturnUrl: 'https://t.me' }
    });
  
    window.__wtTonConnect = tc;
    console.log('[TON] ‚úÖ TonConnect ready');
  
    // ====== –ë–ê–õ–ê–ù–° –ö–û–®–ï–õ–¨–ö–ê ======
    async function fetchWalletBalance() {
      if (!tc.account) {
        walletBalance.textContent = '‚Äî';
        return;
      }
  
      try {
        walletBalance.textContent = 'Loading...';
        
        const address = tc.account.address;
        const response = await fetch(`https://toncenter.com/api/v2/getAddressBalance?address=${address}`);
        const data = await response.json();
  
        if (data.ok && data.result) {
          const balance = fromNano(data.result);
          currentWalletBalance = balance;
          walletBalance.textContent = `${balance} TON`;
          console.log('[TON] ‚úÖ Wallet balance:', balance);
        } else {
          walletBalance.textContent = 'Error';
        }
      } catch (error) {
        console.error('[TON] ‚ùå Balance error:', error);
        walletBalance.textContent = 'Error';
      }
    }
  
    // ====== –û–ë–ù–û–í–õ–ï–ù–ò–ï –ë–ê–õ–ê–ù–°–ê –ü–õ–ê–¢–§–û–†–ú–´ ======
    function updatePlatformBalance(balance) {
      currentBalance = balance;
      
      // –û–±–Ω–æ–≤–∏—Ç—å –≤ topbar
      if (tonAmount) {
        tonAmount.textContent = balance.toFixed(2);
      }
      
      // –û–±–Ω–æ–≤–∏—Ç—å –≤ popup
      if (bigBalance) {
        bigBalance.textContent = Math.floor(balance);
      }
      
      console.log('[TON] üí∞ Platform balance updated:', balance);
    }
  
    // ====== –°–õ–£–®–ê–¢–ï–õ–¨ –°–¢–ê–¢–£–°–ê –ö–û–®–ï–õ–¨–ö–ê ======
    tc.onStatusChange(async (wallet) => {
      if (wallet) {
        console.log('[TON] ‚úÖ Wallet connected:', wallet.account.address);
        await fetchWalletBalance();
      } else {
        console.log('[TON] ‚ùå Wallet disconnected');
        currentWalletBalance = null;
        if (walletBalance) {
          walletBalance.textContent = '‚Äî';
        }
      }
      updateUI();
    });
  
    // ====== UI –û–ë–ù–û–í–õ–ï–ù–ò–ï ======
    function updateUI() {
      const connected = !!tc.account;
      
      console.log('[TON] üé® Updating UI. Connected:', connected);
      
      if (btnConnect) {
        btnConnect.style.display = connected ? 'none' : 'block';
      }
      
      if (btnDeposit) {
        btnDeposit.style.display = connected ? 'block' : 'none';
      }
    }
  
    // ====== –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï –ö–û–®–ï–õ–¨–ö–ê ======
    btnConnect?.addEventListener('click', async (e) => {
      e.preventDefault();
      console.log('[TON] üîå Connect button clicked');
      
      if (tg?.HapticFeedback) {
        tg.HapticFeedback.impactOccurred('medium');
      }
      
      try {
        btnConnect.textContent = 'Connecting...';
        btnConnect.disabled = true;
        
        await tc.openModal();
        
        console.log('[TON] ‚úÖ Wallet modal opened');
        
      } catch (error) {
        console.error('[TON] ‚ùå Connection error:', error);
        
        if (tg?.showAlert) {
          tg.showAlert('Failed to connect wallet. Please try again.');
        }
      } finally {
        btnConnect.textContent = 'Connect Wallet';
        btnConnect.disabled = false;
      }
    });
  
    // ====== –£–í–ï–î–û–ú–õ–ï–ù–ò–ï –°–ï–†–í–ï–†–ê ======
    async function notifyServer(amount, txHash) {
      try {
        const response = await fetch('/api/deposit-notification', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            amount,
            currency: 'ton',
            userId: tgUserId,
            initData,
            txHash,
            timestamp: Date.now()
          })
        });
  
        if (response.ok) {
          console.log('[TON] ‚úÖ Server notified');
          return true;
        } else {
          console.warn('[TON] ‚ö†Ô∏è Server notification failed');
          return false;
        }
      } catch (error) {
        console.error('[TON] ‚ùå Server notification error:', error);
        return false;
      }
    }
  
    // ====== –î–ï–ü–û–ó–ò–¢ ======
    btnDeposit?.addEventListener('click', async (e) => {
      e.preventDefault();
      console.log('[TON] üíé Deposit button clicked');
  
      if (!tc.account) {
        console.warn('[TON] Not connected');
        return;
      }
  
      if (tg?.HapticFeedback) {
        tg.HapticFeedback.impactOccurred('medium');
      }
  
      const amount = DEPOSIT_AMOUNT;
  
      // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
      const nanoAmount = toNanoStr(amount);
      const tx = {
        validUntil: Math.floor(Date.now() / 1000) + 600,
        messages: [{
          address: PROJECT_TON_ADDRESS,
          amount: nanoAmount
        }]
      };
  
      console.log('[TON] üì¶ Transaction:', {
        to: PROJECT_TON_ADDRESS,
        amount: amount + ' TON',
        nano: nanoAmount
      });
  
      const oldText = btnDeposit.textContent;
      btnDeposit.disabled = true;
      btnDeposit.textContent = 'Opening wallet...';
  
      try {
        console.log('[TON] üöÄ Sending transaction...');
  
        const result = await tc.sendTransaction(tx);
  
        console.log('[TON] ‚úÖ Transaction sent!');
        console.log('[TON] Result:', result);
  
        btnDeposit.textContent = 'Processing...';
  
        // –£–≤–µ–¥–æ–º–∏—Ç—å —Å–µ—Ä–≤–µ—Ä
        await notifyServer(amount, result?.boc || null);
  
        // –ü–æ–∫–∞–∑–∞—Ç—å —É—Å–ø–µ—Ö
        if (tg?.showPopup) {
          tg.showPopup({
            title: '‚úÖ Deposit Sent',
            message: `Your deposit of ${amount} TON is being processed.`,
            buttons: [{ type: 'ok' }]
          });
        } else if (tg?.showAlert) {
          tg.showAlert(`‚úÖ Deposit of ${amount} TON sent!`);
        }
  
        if (tg?.HapticFeedback) {
          tg.HapticFeedback.notificationOccurred('success');
        }
  
        // –û–±–Ω–æ–≤–∏—Ç—å –±–∞–ª–∞–Ω—Å (–æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–æ)
        updatePlatformBalance(currentBalance + amount);
  
        // –ó–∞–∫—Ä—ã—Ç—å popup
        setTimeout(() => {
          closePopup();
          btnDeposit.textContent = oldText;
          btnDeposit.disabled = false;
        }, 1500);
  
      } catch (error) {
        console.error('[TON] ‚ùå Transaction error:', error);
  
        let errorMsg = 'Transaction failed. Please try again.';
        
        if (error.message.includes('cancel')) {
          errorMsg = 'Transaction cancelled';
        } else if (error.message.includes('insufficient')) {
          errorMsg = 'Insufficient balance in wallet';
        }
  
        if (tg?.showAlert) {
          tg.showAlert(errorMsg);
        }
  
        if (tg?.HapticFeedback) {
          tg.HapticFeedback.notificationOccurred('error');
        }
  
        btnDeposit.textContent = oldText;
        btnDeposit.disabled = false;
      }
    });
  
    // ====== –ó–ê–ì–†–£–ó–ö–ê –ë–ê–õ–ê–ù–°–ê –ò–ó API ======
    async function loadPlatformBalance() {
      try {
        const response = await fetch(`/api/balance?userId=${tgUserId}`);
        if (response.ok) {
          const data = await response.json();
          if (data.ton !== undefined) {
            updatePlatformBalance(data.ton);
          }
        }
      } catch (error) {
        console.error('[TON] ‚ùå Failed to load balance:', error);
      }
    }
  
    // ====== –°–û–ë–´–¢–ò–Ø ======
    window.addEventListener('balance:update', (e) => {
      if (e.detail?.ton !== undefined) {
        updatePlatformBalance(e.detail.ton);
      }
    });
  
    // ====== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ======
    updateUI();
    loadPlatformBalance();
  
    console.log('[TON] ‚úÖ Module initialized');
    console.log('[TON] Connected:', !!tc.account);
  
    // ====== –≠–ö–°–ü–û–†–¢ ======
    window.WTTonDeposit = {
      openPopup,
      closePopup,
      updateBalance: updatePlatformBalance,
      isConnected: () => !!tc.account,
      getBalance: () => currentBalance
    };
  })();
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  